version: 2
branches:
  ignore:
    - gh-pages
jobs:
  build:
    docker:
      - image: eu.gcr.io/differ-140008/eddi-ci-build
        args:
          CLUSTER_NAME: ${CLUSTER_NAME}
          GOOGLE_COMPUTE_ZONE: ${CLOUDSDK_COMPUTE_ZONE}
          PROJECT_NAME: ${PROJECT_NAME}
        environment:
          ACCT_AUTH: ${ACCT_AUTH}
          APP_NAME: eddi
          DOCKER_IMAGE: ${DOCKER_IMAGE}
          PROJECT_NAME: ${PROJECT_NAME}
          CLUSTER_NAME: ${CLUSTER_NAME}
          CLOUDSDK_COMPUTE_ZONE: ${CLOUDSDK_COMPUTE_ZONE}
          EDDI_JAVA_ENV_MONGODB_HOSTS: mongodb.hosts=eddi-storage-0.eddi-storage
    working_directory: ~/eddi
    steps:
      - checkout
      - setup_remote_docker

      - restore_cache:
          key: eddi
          paths:
            - /root/.m2

      - run: ./tools/ensure-helm-installed.sh

      - run: mvn clean package

      - run: mkdir -p $CIRCLE_TEST_REPORTS/junit/
      - run: find . -type f -regex ".*/target/surefire-reports/.*xml" -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;

      - save_cache:
          key: eddi
          paths:
            - /root/.m2

      - run:
          name: Start container and verify it's working
          command: |
            set -x
            chmod +x integration-tests.sh
            ./integration-tests.sh

      - deploy:
          name: Build and push Docker image
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then

            # todo: get version dynamically?
            export version=4.1.0

            sudo /opt/google-cloud-sdk/bin/gcloud docker build -t $DOCKER_IMAGE:$version-$CIRCLE_BUILD_NUM .
            sudo /opt/google-cloud-sdk/bin/gcloud docker build -t $DOCKER_IMAGE:latest .

            sudo /opt/google-cloud-sdk/bin/gcloud docker push $DOCKER_IMAGE:$version-$CIRCLE_BUILD_NUM
            sudo /opt/google-cloud-sdk/bin/gcloud docker push $DOCKER_IMAGE:latest

            sudo helm upgrade $APP_NAME charts/$APP_NAME --set image.tag=$version-$IMAGE_TAG --install
            fi
